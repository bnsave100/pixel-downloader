<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Downloader dashboard</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.5/angular.min.js"></script>

    <style>
        li {
            cursor: pointer;
        }

        li:hover {
            color: blue;
            text-decoration: underline;
        }

        header, main {
            display: flex;
            flex-wrap: wrap;
        }

        main > div {
            width: 50%;
        }

        #results {
            min-width: 400px;
        }

        #detail img {
            max-width: 200px;
            display: block;
        }

        .active {
            color: red;
            font-weight: bold;
        }

        @media screen and (max-width: 800px) {
            main {
                flex-direction: column-reverse;
            }
        }
    </style>
</head>
<body ng-app="app" ng-controller="ctrl">

<h1>Downloader</h1>

<header>
    <div>
        <h2>Search</h2>
        <form ng-keydown="$event.keyCode === 13 && search()">
            <label for="query">Search query</label><input type="text" id="query" name="query" ng-model="query"/>
            <button type="button" ng-click="search()">Search</button>
            <button type="button" ng-click="recents()">Recents</button>
        </form>
    </div>
    <div ng-if="loading">
        Loading in progress ...
    </div>
</header>

<main>
    <div id="results">
        <h2>Résults :</h2>
        <ul>
            <li ng-repeat="page in resultPages" ng-click="details(page)" ng-class="{ active: page.url == detail.url }">
                {{ page.title }} - {{ page.host }}
            </li>
        </ul>
    </div>

    <div id="detail" ng-if="detail">
        <h2>Détails :
            <button ng-click="closeDetail()">Close</button>
        </h2>

        <h3>
            {{ detail.title }} - {{ detail.host }}
        </h3>
        <div>
            Page: <a target="_blank" href="{{ detail.url }}">{{ detail.url }}</a>
            <img src="{{ detail.image }}" alt="Image"/>
        </div>
        <div>
            <h4>Versions</h4>
            <ul>
                <li ng-repeat="version in detail.relatedPage" ng-click="details(version)">{{ version.title }}
                </li>
            </ul>
        </div>
        <div>
            <h4>Links</h4>
            <div ng-repeat="(host, links) in detail.fileLinksByHost">
                <h5>{{ host }}</h5>
                <!--                <button ng-click="jdownloaderAdd(links)">Add all to queue</button>-->
                <div ng-repeat="link in links">
                    <a target="_blank" href="{{ link.url }}">{{ link.title ? link.title : 'Download' }}</a>
                    <!--                    <button ng-click="jdownloaderAdd(link)">Add to queue</button>-->
                </div>
            </div>
        </div>
    </div>
</main>

</body>

<script>
    var app = angular.module("app", []).config(['$locationProvider', function ($locationProvider) {
        $locationProvider.html5Mode({enabled: true, requireBase: false, rewriteLinks: false});
    }]);
    app.controller("ctrl", function ($location, $scope, $http) {

        $scope.query = getParameterByName('q');
        $scope.resultPages = [];
        $scope.detail = null;
        $scope.loading = false;
        $scope.jdownloaderQueue = [];
        $scope.jdownloaderList = [];
        $scope.sites = [];

        $scope.closeDetail = function () {
            $scope.detail = null;
            history.pushState(null, $scope.query ? $scope.query : '', updateQueryStringParameter(updateQueryStringParameter(window.location.href, 'host', null), 'link', null));
        };

        $scope.getSites = function () {
            $scope.loading = true;
            return $http.get("/sites")
                .then(function (response) {
                    $scope.loading = false;
                    $scope.sites = response.data;
                });
        };

        $scope.recents = function () {
            $scope.loading = true;
            $scope.resultPages = [];
            for (const site of $scope.sites) {
                $http.get("/recents/" + site)
                    .then(function (response) {
                        $scope.loading = false;
                        $scope.resultPages = $scope.resultPages.concat(response.data);
                    });
            }
        };

        $scope.search = function () {
            $scope.loading = true;
            $scope.resultPages = [];

            history.pushState(null, $scope.query, updateQueryStringParameter(window.location.href, 'q', $scope.query));

            for (const site of $scope.sites) {
                $http.get("/search/" + site + "?query=" + $scope.query)
                    .then(function (response) {
                        $scope.loading = false;
                        $scope.resultPages = $scope.resultPages.concat(response.data);
                    });
            }
        };

        $scope.details = function (page) {
            $scope.loading = true;

            history.pushState(null, page.title, updateQueryStringParameter(updateQueryStringParameter(window.location.href, 'host', page.host), 'link', page.url));

            return $http.get("/details?link=" + page.url + "&site=" + page.host)
                .then(function (response) {
                    $scope.loading = false;
                    $scope.detail = response.data;
                    $scope.detail.fileLinksByHost = $scope.detail.fileLinks.reduce(function (rv, x) {
                        (rv[x['host']] = rv[x['host']] || []).push(x);
                        return rv;
                    }, {});
                });
        };

        $scope.jdownloaderGet = function () {
            $scope.loading = true;
            return $http.get("/jdownloader/get")
                .then(function (response) {
                    $scope.loading = false;
                    $scope.jdownloaderList = response.data;
                });
        };

        $scope.jdownloaderGetQueue = function () {
            $scope.loading = true;
            return $http.get("/jdownloader/get-queue")
                .then(function (response) {
                    $scope.loading = false;
                    $scope.jdownloaderQueue = response.data;
                });
        };

        $scope.jdownloaderAdd = function (link) {
            $scope.loading = true;
            return $http.post("/jdownloader/add", JSON.stringify(link))
                .then(function (response) {
                    $scope.loading = false;
                    $scope.jdownloaderQueue = response.data;
                });
        };

        $scope.jdownloaderFlush = function () {
            $scope.loading = true;
            return $http.get("/jdownloader/flush")
                .then(function (response) {
                    $scope.loading = false;
                    $scope.jdownloaderQueue = [];
                    $scope.jdownloaderGet();
                });
        };

        $scope.getSites().then(function () {
            if ($scope.query) {
                $scope.search();
            } else {
                $scope.recents();
            }
            var link = getParameterByName('link');
            var host = getParameterByName('host');
            if (link && host) {
                $scope.details({
                    url: link,
                    host: host
                });
            }
        });
        // $scope.jdownloaderGet();
        // $scope.jdownloaderGetQueue();
    });

    function updateQueryStringParameter(uri, key, value) {
        var re = new RegExp("([?&])" + key + "=.*?(&|#|$)", "i");
        if (!value) {
            if (uri.match(re)) {
                return uri.replace(re, '$1$2');
            } else {
                return uri;
            }
        } else {
            if (uri.match(re)) {
                return uri.replace(re, '$1' + key + "=" + value + '$2');
            } else {
                var hash = '';
                if (uri.indexOf('#') !== -1) {
                    hash = uri.replace(/.*#/, '#');
                    uri = uri.replace(/#.*/, '');
                }
                var separator = uri.indexOf('?') !== -1 ? "&" : "?";
                return uri + separator + key + "=" + value + hash;
            }
        }
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
</script>

</html>
